<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for?(:title) ? yield(:title) : "Kamil LeeÏùò Í∞úÎ∞ú ÏùºÍ∏∞" %></title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    
    <!-- Turbo Ï∫êÏã± ÏµúÏ†ÅÌôî -->
    <meta name="turbo-cache-control" content="max-age=300">
    <%# <meta name="turbo-cache-control" content="no-preview">
    <meta name="turbo-prefetch" content="false"> %>

    <%= yield :head %>
    
    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <!-- Favicon -->
    <%= favicon_link_tag asset_path("brand.png"), rel: "icon", type: "image/png" %>

    <!-- Default Font -->
    <% font_path = asset_path('inter-roman.woff2') %>
    <link rel="preload" href="<%= font_path %>" as="font" type="font/woff2" crossorigin="anonymous">
    <style>
      @font-face {
          font-family: "Inter";
          font-style: normal;
          font-weight: 100 900;
          font-display: swap;
          src: url("<%= font_path %>") format("woff2");
          unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }
    </style>

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    
    <!-- External CSS (loaded after app CSS to ensure proper override) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/themes/prism-tomorrow.min.css" crossorigin="anonymous">
    <%= javascript_importmap_tags %>
  </head>

  <body class="<%= 
    if request.path == '/posts'
      'paged'
    elsif request.path.start_with?('/category/')
      tag_class = "tag-#{params[:name].gsub(' ', '-')}"
      "tag-template #{tag_class}".strip
    elsif @post.present? && params[:action] == 'show'
      category_class = @post.category.present? ? "tag-#{@post.category.downcase.gsub(' ', '-')}" : ''
      "post-template #{category_class}".strip
    else
      'home-template'
    end
  %> has-sans-title has-sans-body">
    <div class="gh-viewport">
      <%= render "shared/header" %>

      <%= yield %>
      
      <%= render "shared/footer" %>
    </div>

    <!-- External JavaScript Libraries (loaded at end of body for performance) -->
    <!-- MathJax v4 Configuration -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$']],
          displayMath: [['$$', '$$']]
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"></script>
       
    <!-- PrismJS for code syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-core.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/plugins/autoloader/prism-autoloader.min.js" crossorigin="anonymous"></script>
    
    <!-- PrismJS Turbo Ìò∏ÌôòÏÑ± Ïä§ÌÅ¨Î¶ΩÌä∏ -->
    <script>
      function initializePrism() {
        if (typeof Prism !== 'undefined') {
          // Í∏∞Ï°¥ ÌïòÏù¥ÎùºÏù¥ÌåÖ Ï†úÍ±∞ ÌõÑ Ïû¨Ïã§Ìñâ
          document.querySelectorAll('pre code').forEach(block => {
            block.className = block.className.replace(/language-\w+/, match => match);
          });
          Prism.highlightAll();
          console.log('üé® PrismJS highlighted:', document.querySelectorAll('pre code').length, 'code blocks');
        }
      }
      
      function initializeMathJax() {
        if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
          MathJax.typesetPromise().then(() => {
            console.log('üßÆ MathJax rendered');
          }).catch(err => console.error('MathJax error:', err));
        }
      }
      
      // Turbo Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
      document.addEventListener('turbo:load', function() {
        setTimeout(() => {
          initializePrism();
          initializeMathJax();
        }, 50); // ÏßßÏùÄ ÏßÄÏó∞ÏúºÎ°ú DOM ÏïàÏ†ïÌôî ÎåÄÍ∏∞
      });
      
      document.addEventListener('turbo:render', function() {
        setTimeout(() => {
          initializePrism();
          initializeMathJax();
        }, 50);
      });
      
      // Ï¥àÍ∏∞ Î°úÎìúÏóêÏÑúÎèÑ Ïã§Ìñâ
      document.addEventListener('DOMContentLoaded', function() {
        initializePrism();
        initializeMathJax();
      });
    </script>
  </body>
</html>
