<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for?(:title) ? yield(:title) : "Kamil Leeì˜ ê°œë°œ ì¼ê¸°" %></title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <!-- Turbo ìºì‹œ ì œì–´: 5ë¶„ê°„ ìºì‹± -->
    <meta name="turbo-cache-control" content="max-age=300">

    <%= yield :head %>

    <%# PWA manifest - í˜„ìž¬ ë¹„í™œì„±í™” %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <!-- Favicon -->
    <%= favicon_link_tag asset_path("brand.png"), rel: "icon", type: "image/png" %>

    <!-- ê¸°ë³¸ í°íŠ¸: Inter -->
    <% font_path = asset_path('inter-roman.woff2') %>
    <link rel="preload" href="<%= font_path %>" as="font" type="font/woff2" crossorigin="anonymous">
    <style>
      @font-face {
        font-family: "Inter";
        font-style: normal;
        font-weight: 100 900;
        font-display: swap;
        src: url("<%= font_path %>") format("woff2");
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }
    </style>

    <%# ì• í”Œë¦¬ì¼€ì´ì…˜ ìŠ¤íƒ€ì¼ì‹œíŠ¸ %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>

    <%# ì™¸ë¶€ CSS: PrismJS ì½”ë“œ í•˜ì´ë¼ì´íŒ… í…Œë§ˆ %>
    <%= stylesheet_link_tag "https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/themes/prism-tomorrow.min.css",
                            crossorigin: "anonymous",
                            integrity: false %>

    <%# JavaScript ë²ˆë“¤ (esbuildë¡œ ë¹Œë“œ) %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", type: "module" %>
  </head>

  <body class="<%=
    if request.path == '/posts'
      'paged'
    elsif request.path.start_with?('/category/')
      tag_class = "tag-#{params[:name].gsub(' ', '-')}"
      "tag-template #{tag_class}".strip
    elsif request.path.start_with?('/author/')
      "author-template"
    elsif @post.present? && params[:action] == 'show'
      category_class = @post.category.present? ? "tag-#{@post.category.downcase.gsub(' ', '-')}" : ''
      "post-template #{category_class}".strip
    else
      'home-template'
    end
  %> has-sans-title has-sans-body" data-controller="global">
    <div class="gh-viewport">
      <%= render "shared/header" %>

      <%= yield %>

      <%= render "shared/footer" %>
    </div>

    <%# ëª¨ë‹¬ ì»´í¬ë„ˆíŠ¸ %>
    <%= render "shared/subscribe_modal" %>
    <%= render "shared/search_modal" %>
    <%= render "shared/authorization_modal" %>
    <%= render "shared/account_modal" %>

    <%# ì™¸ë¶€ JavaScript ë¼ì´ë¸ŒëŸ¬ë¦¬ %>

    <%# MathJax v4: ìˆ˜ì‹ ë Œë”ë§ %>
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$']],
          displayMath: [['$$', '$$']]
        }
      };
    </script>
    <%= javascript_include_tag "https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js",
                               id: "MathJax-script",
                               async: true,
                               defer: true %>

    <%# PrismJS: ì½”ë“œ ì‹ íƒìŠ¤ í•˜ì´ë¼ì´íŒ… %>
    <%= javascript_include_tag "https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-core.min.js",
                               crossorigin: "anonymous" %>
    <%= javascript_include_tag "https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/plugins/autoloader/prism-autoloader.min.js",
                               crossorigin: "anonymous" %>

    <%# PrismJS & MathJax Turbo í˜¸í™˜ì„± %>
    <script>
      function initializePrism() {
        if (typeof Prism !== 'undefined') {
          // ê¸°ì¡´ í•˜ì´ë¼ì´íŒ… ì œê±° í›„ ìž¬ì‹¤í–‰
          document.querySelectorAll('pre code').forEach(block => {
            block.className = block.className.replace(/language-\w+/, match => match);
          });
          Prism.highlightAll();
          console.log('ðŸŽ¨ PrismJS highlighted:', document.querySelectorAll('pre code').length, 'code blocks');
        }
      }

      function initializeMathJax() {
        if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
          MathJax.typesetPromise().then(() => {
            console.log('ðŸ§® MathJax rendered');
          }).catch(err => console.error('MathJax error:', err));
        }
      }

      // Turbo ë¼ì´í”„ì‚¬ì´í´ ì´ë²¤íŠ¸
      document.addEventListener('turbo:load', () => {
        setTimeout(() => {
          initializePrism();
          initializeMathJax();
        }, 50);
      });

      document.addEventListener('turbo:render', () => {
        setTimeout(() => {
          initializePrism();
          initializeMathJax();
        }, 50);
      });

      // ì´ˆê¸° íŽ˜ì´ì§€ ë¡œë“œ
      document.addEventListener('DOMContentLoaded', () => {
        initializePrism();
        initializeMathJax();
      });
    </script>
  </body>
</html>
